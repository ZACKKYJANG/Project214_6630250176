<template>
  <div class="container">
    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß -->
    <div class="card mt-4 card-custom">
      <div class="card-body d-flex">
        <img src="../public/img/nok.jpg" alt="‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô" class="img-thumbnail mb-3" style="width: 300px; height: 400px; object-fit: cover;" />
        <div class="card-body d-flex align-items-center">
        <div class="me-5">
          <h5 class="card-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h5>

    <p class="text-start w-100">
</p>
    <p><strong>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏¥‡∏™‡∏¥‡∏ï:</strong> {{ student.id }}</p>
    <p><strong>üë§‡∏ä‡∏∑‡πà‡∏≠:</strong> {{ student.name }}</p>
    <p><strong>üè∑Ô∏è‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤:</strong> {{ student.major_id }}</p>
    <p><strong>üìñ‡∏™‡∏≤‡∏Ç‡∏≤:</strong> {{ student.major_name }}</p>
    <p><strong>üè´‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏î‡∏¥‡∏°:</strong> {{ student.old_school }}</p>

    <button class="btn btn-primary" @click="toggleProfileEdit">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</button>
        </div>
  </div>
  
        <img src="../public/img/bird.jpg" alt="‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô" 
     class="img-thumbnail mb-3 ms-auto bird" 
     style="width: 300px; height: 400px; object-fit: cover;" />


      </div>
    </div>

    <div v-if="isProfileEditMode" class="mt-3">
            <h5>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h5>
            <form @submit.prevent="saveStudent">
              <div class="mb-3">
                <label for="name" class="form-label">‡∏ä‡∏∑‡πà‡∏≠</label>
                <input v-model="editStudent.name" type="text" id="name" class="form-control" required />
              </div>
              <div class="mb-3">
                <label for="major_id" class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤</label>
                <input v-model="editStudent.major_id" type="text" id="major_id" class="form-control" required />
              </div>
              <div class="mb-3">
                <label for="major_name" class="form-label">‡∏™‡∏≤‡∏Ç‡∏≤</label>
                <input v-model="editStudent.major_name" type="text" id="major_name" class="form-control" required />
              </div>
              <div class="mb-3">
                <label for="old_school" class="form-label">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏î‡∏¥‡∏°</label>
                <input v-model="editStudent.old_school" type="text" id="old_school" class="form-control" required />
              </div>
              <button type="submit" class="btn btn-success">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </form>
          </div>

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤ -->
    <div class="card mt-4 card-custom">
      <div class="card-body">
        <h5 class="card-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤</h5>
        <table class="table">
          <thead>
            <tr>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</th>
              <th>‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤</th>
              <th>‡πÄ‡∏Å‡∏£‡∏î</th>
              <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï</th>
              <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(subject, index) in subjects" :key="subject.id">
              <td>{{ subject.name }}</td>
              <td>{{ subject.id }}</td>
              <td>{{ subject.grade }}</td>
              <td>{{ subject.credit }}</td>
              <td>
                <button class="btn btn-info btn-sm" @click="openModal('edit', subject)">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button class="btn btn-danger btn-sm" @click="deleteSubject(index)">‡∏•‡∏ö</button>
              </td>
            </tr>
          </tbody>
        </table>
        <button class="btn btn-primary" @click="openModal('add')">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤</button>
      </div>
    </div>

    <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏¥‡∏ä‡∏≤ -->
    <div class="modal fade" id="subjectModal" tabindex="-1" aria-labelledby="subjectModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="subjectModalLabel">{{ isEditMode ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏¥‡∏ä‡∏≤' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤' }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form @submit.prevent="saveSubjectForm">
              <div class="mb-3">
                <label for="subject-name" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</label>
                <input v-model="currentSubject.name" type="text" id="subject-name" class="form-control" required />
              </div>
              <div class="mb-3">
                <label for="subject-id" class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤</label>
                <input v-model="currentSubject.id" type="text" id="subject-id" class="form-control" required />
              </div>
              <div class="mb-3">
                <label for="subject-grade" class="form-label">‡πÄ‡∏Å‡∏£‡∏î</label>
                <input v-model="currentSubject.grade" type="text" id="subject-grade" class="form-control" required />
              </div>
              <div class="mb-3">
                <label for="subject-credit" class="form-label">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï</label>
                <input v-model="currentSubject.credit" type="text" id="subject-credit" class="form-control" required />
              </div>
              <button type="submit" class="btn btn-success">{{ isEditMode ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : '‡πÄ‡∏û‡∏¥‡πà‡∏°' }}</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';

let id_now = "";

// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î URL ‡∏Ç‡∏≠‡∏á json-server
const apiUrl = 'http://localhost:3000';

// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
const student = ref({
  id: '',
  name: '',
  major_id: '',
  major_name: '',
  old_school: '',
});


const editStudent = ref({})

// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤
const subjects = ref([]);
const isProfileEditMode = ref(false);

// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
const isEditMode = ref(false);
const currentSubject = ref({});

const saveStudent = async () => {
  try {
    await fetch(`${apiUrl}/students/`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(editStudent.value),
    });
    student.value = { ...editStudent.value };
    isProfileEditMode.value = false; // ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
  } catch (error) {
    console.error('Error saving student data:', error);
  }
};


const toggleProfileEdit = () => {
  isProfileEditMode.value = !isProfileEditMode.value;
  editStudent.value = { ...student.value };
};

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å json-server
const loadData = async () => {
  try {
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
    const studentResponse = await fetch(`${apiUrl}/students/`); // ‡πÉ‡∏ä‡πâ id 1 ‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
    const studentData = await studentResponse.json();
    student.value = studentData;

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤
    const subjectsResponse = await fetch(`${apiUrl}/subjects`);
    const subjectsData = await subjectsResponse.json();
    subjects.value = subjectsData;
  } catch (error) {
    console.error('Error loading data:', error);
  }
};

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏¥‡∏ä‡∏≤
const openModal = (mode, subject = {}) => {
  isEditMode.value = mode === 'edit';
  currentSubject.value = { ...subject };
  id_now = subject.id;
  const modal = new bootstrap.Modal(document.getElementById('subjectModal'));
  modal.show();
};

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤
const saveSubjectForm = async () => {
  try {
    // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    if (isEditMode.value) {
      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ç‡∏≠‡∏á currentSubject ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      if (currentSubject.value.id !== id_now.value) {
        // ‡∏•‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô
        await fetch(`${apiUrl}/subjects/${id_now}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
        });
      }

      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏´‡∏°‡πà (‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°)
      await fetch(`${apiUrl}/subjects/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(currentSubject.value),
      });
    } else {
      // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏´‡∏°‡πà
      await fetch(`${apiUrl}/subjects`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(currentSubject.value),
      });
    }

    // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    loadData();

    // ‡∏õ‡∏¥‡∏î Modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('subjectModal'));
    modal.hide();
  } catch (error) {
    console.error('Error saving subject:', error);
  }
};


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤
const deleteSubject = async (index) => {
  const subjectId = subjects.value[index].id;

  try {
    await fetch(`${apiUrl}/subjects/${subjectId}`, {
      method: 'DELETE',
    });
    subjects.value.splice(index, 1);
  } catch (error) {
    console.error('Error deleting subject:', error);
  }
};

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏°‡πÇ‡∏û‡πÄ‡∏ô‡∏ô‡∏ï‡πå‡∏ñ‡∏π‡∏Å‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á
onMounted(loadData);
</script>

<style scoped>
.container {
  background-color: #66ff736b;
}

.card-custom {
  border: 2px solid #007bff;
  border-radius: 8px;
  background-color: #80d6f8;
}
.bird{
  margin-right: 70px;
}
</style>
